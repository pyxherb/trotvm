import rcobj;

namespace xy {
	using allocator_alloc_t = fn (size: usize, alignment: usize): void*;
	using allocator_dealloc_t = fn (ptr: void*, size: usize, alignment: usize);
	using allocator_realloc_t = fn (ptr: void*, size: usize, alignment: usize);

	[c_ffi_name("xy_allocator_t")]
	struct allocator_t {
		let {
			rcobj: rcobj_t,
			alloc_callback: allocator_alloc_t,
			dealloc_callback: allocator_dealloc_t,
			realloc_callback: allocator_realloc_t
		}
		fn {
			[c_ffi_name("xy_allocator_defer")]
			fn defer() {
				@bugcheck(this.rcobj.getref() == 0);
			}

			[c_ffi_name("xy_allocator_as_rcobj")]
			fn as_rcobj(): rcobj_t& {
				return this.rcobj;
			}

			[c_ffi_name("xy_allocator_alloc")]
			fn alloc(size: usize, alignment: usize): void* {
				return this.alloc_callback(size, alignment);
			}

			[c_ffi_name("xy_allocator_dealloc")]
			fn dealloc(ptr: void*, size: usize, alignment: usize) {
				return this.dealloc_callback(ptr, size, alignment);
			}

			[c_ffi_name("xy_allocator_realloc")]
			fn realloc(ptr: void*, old_size: usize, new_size: usize, alignment: usize) {
				return this.realloc_callback(ptr, size, alignment);
			}
		}
	}
}
